<?php
error_reporting(E_ALL);
ini_set('display_errors', False);

// Connects to the Database
   	include('recaptchalib.php');
	include('connect.php');
	connect();
	
        $check = mysql_query("SELECT * FROM users WHERE username = '".$_COOKIE['hackme']."'")or die(mysql_error());
        $check2 = mysql_num_rows($check);
        if ($check2 == 0) {
            die("<p>Sorry, user name does not exisits.</p>");
        }
        else {
            while($info = mysql_fetch_array( $check ))      {
                 $lname = $info['lname'];
            }
	}
	//if the login form is submitted 
	if (isset($_POST['post_submit'])) {
	   $privatekey = "6LerkNcSAAAAAOa8uMlsXrHBgbtDeyC0_IZzzfuv";

	   $resp = recaptcha_check_answer ($privatekey,
	   	   $_SERVER["REMOTE_ADDR"],
	   	   $_POST["recaptcha_challenge_field"],
	   	   $_POST["recaptcha_response_field"]);

	   if (!$resp->is_valid) {
	      ?>
		<script type="text/javascript">
			window.onload = function capt_error() {
			      var error = document.getElementById("captcha_error");
			      error.innerHTML = <?php echo('"'.$resp->error.'"')?>;
			 }
		</script>
              <?php
	   }
	   else {
	   if(!$_POST['title'] | !$_POST['message'] | !$_POST['lname']) {
			include('header.php');
			die('<p>You did not fill in a required field.
			Please go back and try again!</p>');
		}
		

		mysql_query("INSERT INTO threads (username, title, message, date) VALUES('".$_COOKIE['hackme']."', '". $_POST['title']."', '". $_POST[message]."', '".time()."')")or die(mysql_error());
		
		
		header("Location: members.php");
	}
	}
?>  
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>hackme</title>
<link href="style.css" rel="stylesheet" type="text/css" media="screen" />
<?php
	include('header.php');
?>
<div class="post">
	<div class="post-bgtop">
		<div class="post-bgbtm">
        <h2 class = "title">hackme bulletin board</h2>
        	<?php
            if(!isset($_COOKIE['hackme'])){
				 die('Why are you not logged in?!');
			}else
			{
				print("<p>Logged in as <a>$_COOKIE[hackme]</a></p>");
			}
			?>
            
            <h2 class="title">NEW POST</h2>
            <p class="meta">by <a href="#"><? echo $_COOKIE['hackme'] ?> </a></p>
            <p> do not leave any fields blank... </p>
            
            <form method="post" action="post.php">
            Title: <input type="text" name="title" maxlength="50"/>
            <br />
            <br />
            Posting:
            <br />
            <br />
            <textarea name="message" cols="120" rows="10" id="message"></textarea>
            <br />
            <br />
            <input name="lname" type="hidden" value=<?php echo($lname); ?> />
            <input name="post_submit" type="submit" id="post_submit" value="POST" />
     <script type="text/javascript"
       src="http://www.google.com/recaptcha/api/challenge?k=6LerkNcSAAAAAJZnQozI23m0u8sID-4aswBZhY11">
     </script>
     <noscript>
     <iframe src="http://www.google.com/recaptcha/api/noscript?k=6LerkNcSAAAAAJZnQozI23m0u8sID-4aswBZhY11"
       height="300" width="500" frameborder="0"></iframe><br>
     <textarea name="recaptcha_challenge_field" rows="3" cols="40">
     </textarea>
     <input type="hidden" name="recaptcha_response_field"
        value="manual_challenge">
    </noscript>
</form>
    <p id="captcha_error"></p>
        </div>
    </div>
</div>

<?php
	include('footer.php');
?>
</body>
</html>