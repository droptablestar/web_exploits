<?php
	  // ini_set('display_errors', 'On');
	  // error_reporting(E_ALL);
	// Connect to db create an instance $conn
	include('connect.php');
	connect();
	$conn = new PDO("mysql:host=localhost;dbname=cs526p1", "cs526f12", "\$troNg_PasSWord!");
	
	//if the login form is submitted 
	if (isset($_POST['submit'])) {
		
		$_POST['username'] = trim($_POST['username']);
		if(!$_POST['username'] | !$_POST['password']) {
			die('<p>You did not fill in a required field.
			Please go back and try again!</p>');
		}
		
		$passwordHash = hash('sha256', $_POST['password']);

		//php prepared sql statement
		$q = $conn-> prepare('SELECT * 
							 FROM users 
							 WHERE username = ?');	

		//setting input values to parameters
		$username = $_POST['username'];
		
		//binding input to parameters
		$q -> execute(array($username));
		
		//set a count
		$count = 0;
				
		while ($row = $q->fetch(PDO::FETCH_OBJ)){
		     //count rows return for check in validation section of code
			 $count = count($row); 
			 
			 //set count to $check2 to integrate with old code
			$check2 = $count;
			
			if ($check2 == 0) {
				die('Sorry, user name does not exisits.');
			}
			else
			{
				
				//gives error if the password is wrong
				if ($passwordHash != $row->pass) {
					die('Incorrect password, please try again.');
				}
					
				$hour = time() + 3600; 
				setcookie(hackme, $_POST['username'], $hour); 
				setcookie(hackme_pass, $passwordHash, $hour);
				header("Location: members.php");
			}
		}
		
		
	}
		?>  
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>hackme</title>
<link href="style.css" rel="stylesheet" type="text/css" media="screen" />
<?php
	include('header.php');
?>
<div class="post">
	<div class="post-bgtop">
		<div class="post-bgbtm">
        <h2 class = "title">hackme bulletin board</h2>
        	<?php
            if(!isset($_COOKIE['hackme'])){
				 die('Why are you not logged in?!');
			}else
			{
				print("<p>Logged in as <a>$_COOKIE[hackme]</a></p>");
			}
			?>
        </div>
    </div>
</div>

<?php
	$threads = mysql_query("SELECT * FROM threads ORDER BY date DESC")or die(mysql_error());
	while($thisthread = mysql_fetch_array( $threads )){
?>
	<div class="post">
	<div class="post-bgtop">
	<div class="post-bgbtm">
		<h2 class="title"><a href="show.php?pid=<? echo $thisthread[id] ?>"><? echo $thisthread[title]?></a></h2>
							<p class="meta"><span class="date"> <? echo date('l, d F, Y',$thisthread[date]) ?> - Posted by <a href="#"><? echo $thisthread[username] ?> </a></p>

	</div>
	</div>
	</div> 

<?php
}
	include('footer.php');
?>
</body>
</html>